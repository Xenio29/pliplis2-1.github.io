<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tâches - Gestion</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="app.js"></script>
    <script>
		// Rendu spécifique à la page des tâches (asynchrone Supabase)
		async function renderTasks() {
			const tasks = await fetchTasks(); // récupère depuis Supabase
			const list = document.getElementById('tasks-by-room');
			list.innerHTML = '';
			const groups = {};
			tasks.forEach(t=>{
				const task = ensureTaskPeriodicity(t);
				(groups[task.room] = groups[task.room] || []).push(task);
			});
			if (!Object.keys(groups).length) { list.innerHTML='<div>Aucune tâche</div>'; return; }

			Object.keys(groups).sort().forEach(room=>{
				const wrapper=document.createElement('div');
				wrapper.innerHTML=`<h3>${room}</h3>`;
				const ul=document.createElement('ul');
				groups[room].forEach(task=>{
					const { progress, remainingDays } = progressPercent(task);
					const isOverdue = remainingDays < 0;
					const li=document.createElement('li');
					li.className='task '+(task.finished?'finished':'pending');
					li.innerHTML=`
						<strong>${task.title}</strong>
						${isOverdue ?
							`<span style="color:red;font-weight:bold;margin-left:8px;">Cette tâche est en retard !</span>` :
							`<div class="progress-mini"><div class="bar" style="width:${progress}%;"></div></div>
							 <span style="margin-left:8px;">${Math.abs(remainingDays)} jour(s) ${remainingDays<0?'de retard':'restant(s)'}</span>`}
						<div class="task-actions">
							<button class="btn" onclick="markTaskToggle('${task.id}')"><span>${task.finished?'Annuler':'Fini'}</span></button>
							<button class="btn" onclick="resetTaskTimer('${task.id}')"><span>Réinitialiser</span></button>
							<button class="btn" onclick="deleteTask('${task.id}')"><span>Supprimer</span></button>
						</div>`;
					if(isOverdue){ li.style.color='red'; li.style.fontSize='1.1em'; li.style.fontWeight='bold'; }
					ul.appendChild(li);
				});
				wrapper.appendChild(ul);
				list.appendChild(wrapper);
			});
		}

		// Initialisation spécifique à la page des tâches
		window.onload = function() {
			document.getElementById('task-form').addEventListener('submit', addTaskFromForm);
			renderTasks();
		};
	</script>
</head>
<body>
	<div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar(false)"></div>
	<button class="sidebar-toggle" aria-label="Ouvrir le menu" onclick="toggleSidebar(true)">☰ Menu</button>
	<div class="app">
		<aside class="sidebar card" aria-label="Navigation">
			<button class="sidebar-close" aria-label="Fermer le menu" onclick="toggleSidebar(false)">✕</button>
			<div class="brand">Maison • Gestion</div>
			<nav>
				<a href="index.html">Accueil</a>
				<a href="taches.html">Tâches</a>
				<a href="courses.html">Courses</a>
				<a href="repas.html">Repas</a>
				<a href="weather.html">Météo</a>
			</nav>
			<div class="separator" aria-hidden="true"></div>
			<div class="sidebar-footer">
				<div class="small">Thème</div>
				<div class="theme-select-wrapper">
					<select id="theme-select" class="theme-select">
						<option value="system">Système</option>
						<option value="light">Clair</option>
						<option value="dark">Sombre</option>
					</select>
				</div>
			</div>
		</aside>

		<main class="main">
			<h1>Tâches</h1>

			<section class="card">
				<h2>Ajouter une tâche</h2>
				<form id="task-form">
					<div class="form-row">
						<div class="input-container">
							<input id="t-title" type="text" placeholder=" " required>
							<label for="t-title">Titre de la tâche</label>
						</div>
						
						<div class="select-container">
							<select id="t-period" required>
								<option value="1">Quotidienne</option>
								<option value="2">Biquotidienne</option>
								<option value="3">Triquotidienne</option>
								<option value="5">Quintiquotidienne</option>
								<option value="7">Hebdomadaire</option>
								<option value="30">Mensuelle</option>
								<option value="90">Trimestrielle</option>
								<option value="365">Annuelle</option>
							</select>
						</div>
						
						<div class="select-container">
							<select id="t-room" required>
								<option value="Cuisine">Cuisine</option>
								<option value="Salle de bain">Salle de bain</option>
								<option value="Plan de cuisine">Plan de cuisine</option>
								<option value="Bureau">Bureau</option>
								<option value="Lit">Lit</option>
								<option value="Placard">Placard</option>
								<option value="Poubelles">Poubelles</option>
								<option value="Salle de vie">Salle de vie</option>
								<option value="Partout">Partout</option>
								<option value="Autre">Autre</option>
							</select>
						</div>
					</div>
					
					<button type="submit" class="btn"><span>Ajouter la tâche</span></button>
				</form>
			</section>

			<section class="card">
				<h2>Tâches triées par pièce</h2>
				<div id="tasks-by-room"></div>
			</section>
		</main>
	</div>
	<script>
		// gestion du thème (commune à toutes les pages)
		(function(){
			const KEY = 'home_theme_v1';
			function applyTheme(mode){
				if(mode === 'system'){
					document.documentElement.removeAttribute('data-theme');
				} else {
					document.documentElement.setAttribute('data-theme', mode);
				}
				localStorage.setItem(KEY, mode);
			}
			function init(){
				const select = document.getElementById('theme-select');
				if(!select) return;
				const saved = localStorage.getItem(KEY) || 'system';
				select.value = saved;
				applyTheme(saved);
				select.addEventListener('change', e => applyTheme(e.target.value));
			}
			document.addEventListener('DOMContentLoaded', init);
			const media = window.matchMedia('(prefers-color-scheme: dark)');
			if(media.addEventListener){
				media.addEventListener('change', () => {
					if((localStorage.getItem(KEY) || 'system') === 'system'){
						applyTheme('system');
					}
				});
			}
		})();
	</script>
</body>
</html>